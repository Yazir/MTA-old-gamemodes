heistTable = {
	factory = {
		["timers"] = {},
		["name"] = "Uzależnienie", ["levelReq"] = 26, ["entrancepos"] = {9999,9999,9999}, ["startpos"] = {2543.3679199219,-1304.2523193359,1025.0743408203}, ["cashpos"] = {2548.2553710938,-1282.2822265625,1060}, ["coppos"] = {2554.6779785156,-1303.9338378906,1054.640625},
		["difficulty"] = 3,
		["dim"] = 1001,
		["int"] = 2,
		["botCount"] = 55, ["waveBotCount"] = 7, ["botExp"] = 3,
		["time"] = 30,
		["reward"] = 400,
		["bots"] = {
			{2535.0815429688,-1320.9011230469,1031.421875},{2526.90625,-1318.5487060547,1031.421875},{2524.0629882813,-1310.95703125,1031.421875},{2528.0964355469,-1289.8010253906,1031.421875},{2524,-1298.3664550781,1031.421875},{2535.1984863281,-1293.1101074219,1031.421875},{2540.12890625,-1303.8138427734,1031.421875},{2540.1342773438,-1283.8959960938,1031.421875},{2548.3210449219,-1291.6557617188,1031.421875},{2541.6411132813,-1295.9326171875,1031.421875},{2550.5812988281,-1299.6968994141,1031.421875},{2559.0002441406,-1287.9525146484,1031.421875},{2559.671875,-1299.8363037109,1031.421875},{2559.7583007813,-1295.9289550781,1031.421875},{2569.6298828125,-1302.5146484375,1031.421875},{2568.1101074219,-1295.7250976563,1031.421875},{2567.6743164063,-1289.7861328125,1031.421875},{2570.9907226563,-1286.5599365234,1031.421875},{2569.6364746094,-1284.0162353516,1031.421875},{2575.4047851563,-1299.3623046875,1037.7734375},{2576.6384277344,-1299.8254394531,1037.7734375},{2567.6911621094,-1293.5208740234,1037.7734375},{2567.3466796875,-1305.0404052734,1037.7734375},{2580.1357421875,-1304.4660644531,1037.7734375},{2581.4616699219,-1285.6135253906,1044.125},{2578.7180175781,-1286.0982666016,1044.125},{2575.7231445313,-1281.3708496094,1044.125},{2574.6630859375,-1304.5303955078,1044.125},{2576.8752441406,-1298.3624267578,1045.0704345703},{2564.9494628906,-1286.3159179688,1044.125},{2557.2775878906,-1285.0349121094,1044.125},{2548.7702636719,-1284.5144042969,1044.125},{2541.2238769531,-1284.2454833984,1044.125},{2549.4741210938,-1290.2957763672,1044.125},{2549.9416503906,-1302.3709716797,1044.125},{2557.6796875,-1303.0804443359,1044.125},{2568.8547363281,-1304.6112060547,1044.125},{2541.3383789063,-1302.4162597656,1044.125},{2536.0910644531,-1298.3424072266,1044.125},{2531.9299316406,-1289.3250732422,1045.4089355469},{2532.9982910156,-1283.4240722656,1048.2890625},{2537.5061035156,-1280.3315429688,1048.2890625},{2543.072265625,-1283.1120605469,1048.2890625},{2560.5373535156,-1283.1129150391,1048.2890625},{2569.2648925781,-1283.9012451172,1048.2890625},{2568.8393554688,-1306.7725830078,1048.2890625},{2565.8386230469,-1305.3170166016,1048.2890625},{2562.8215332031,-1306.2468261719,1048.2890625},{2525.9821777344,-1294.9916992188,1048.2890625},{2528.4851074219,-1293.5500488281,1048.2890625},{2526.6970214844,-1286.0340576172,1048.2890625},{2519.8046875,-1305.8140869141,1048.2890625},{2519.3911132813,-1289.0653076172,1054.640625},{2520.7651367188,-1288.8166503906,1054.640625},{2521.1008300781,-1281.5302734375,1054.640625},{2519.3537597656,-1281.46484375,1054.640625},{2528.6140136719,-1287.4903564453,1054.640625},{2529.4165039063,-1284.1591796875,1054.640625},{2529.6481933594,-1285.9772949219,1054.640625},{2539.8190917969,-1283.3393554688,1054.640625},{2540.1491699219,-1286.4448242188,1054.640625},{2534.8842773438,-1293.6708984375,1054.640625},{2533.7053222656,-1291.4698486328,1054.640625},{2541.4155273438,-1295.8048095703,1054.640625},{2533.8974609375,-1301.7260742188,1054.640625},{2533.6159667969,-1305.0434570313,1054.640625},{2530.8950195313,-1303.0993652344,1054.640625},{2539.4250488281,-1304.1163330078,1054.640625},{2546.8720703125,-1304.7214355469,1054.6469726563},{2545.5009765625,-1291.1008300781,1054.640625},{2549.1552734375,-1289.9908447266,1054.640625},{2555.5979003906,-1291.8732910156,1054.640625},{2555.87109375,-1282.7830810547,1054.640625},{2565.2365722656,-1282.7183837891,1054.640625},{2568.4624023438,-1281.8864746094,1054.640625},{2555.4807128906,-1287.0184326172,1054.640625},{2559.87890625,-1303.3078613281,1054.640625},{2564.6291503906,-1301.9760742188,1054.8240966797},{2572.7795410156,-1299.9937744141,1054.640625},{2574.998046875,-1299.5903320313,1054.640625},{2572.9643554688,-1287.7587890625,1054.640625},{2572.7421875,-1283.3195800781,1054.640625},{2580.3352050781,-1284.0294189453,1054.640625},{2580.7199707031,-1297.0219726563,1060.9111328125},{2578.2094726563,-1297.4908447266,1060.9921875},{2575.2468261719,-1287.2983398438,1065.3671875},{2562.9135742188,-1281.6440429688,1065.3671875},{2582.0646972656,-1285.3883056641,1065.359375},{2582.0654296875,-1282.9298095703,1065.359375},{2579.7861328125,-1283.330078125,1065.3596191406},{2579.0083007813,-1285.890625,1065.3594970703},{2582.5581054688,-1283.5260009766,1065.359375},{2551.818359375,-1293.8948974609,1060.984375},{2549.8630371094,-1295.0145263672,1060.984375},{2549.5729980469,-1292.3507080078,1060.984375},{2551.1452636719,-1288.2420654297,1060.984375},{2557.1960449219,-1292.8002929688,1060.984375},{2559.5354003906,-1296.3657226563,1060.984375},{2559.9201660156,-1302.3179931641,1060.984375},{2575.1047363281,-1286.7269287109,1060.984375},{2575.1833496094,-1284.2863769531,1060.984375},{2573.724609375,-1281.6763916016,1066.0935058594},{2566.5903320313,-1296.3973388672,1063.251953125},{2567.0695800781,-1293.5068359375,1063.251953125},{2548.3774414063,-1282.861328125,1060.984375},
		},

		["status"] = "waiting", ["open"] = false, ["plaCount"] = 0, ["allPlayers"] = {},
	},
	sfarmyship = {
		["timers"] = {},
		["name"] = "Problem z rybką", ["levelReq"] = 16, ["entrancepos"] = {9999,9999,9999}, ["startpos"] = {-1473.8156738281,688.63299560547,-0.55000001192093}, ["coppos"] = {-1292.7066650391,490.44766235352,11.1953125}, ["cashpos"] = {-1459.0355224609,498.62307739258,10.0078125},
		["bots"] = {{-1463.6614990234,514.11291503906,3.0413770675659},{-1463.6607666016,488.50888061523,3.0413770675659},{-1423.0494384766,514.03466796875,3.1608240604401},{-1424.1870117188,509.43481445313,3.0390625},{-1424.1378173828,502.13565063477,3.0463349819183},{-1419.6617431641,502.54495239258,3.0463349819183},{-1414.5684814453,508.66372680664,3.0390625},{-1410.6654052734,506.58773803711,3.0390625},{-1393.5269775391,511.97882080078,3.1244518756866},{-1388.1585693359,513.13757324219,3.0390625},{-1383.9554443359,507.28866577148,3.0390625},{-1386.6767578125,502.74807739258,3.0390625},{-1391.3686523438,498.37405395508,3.0390625},{-1398.5852050781,492.67175292969,5.2716755867004},{-1401.5091552734,490.52325439453,5.2716755867004},{-1405.7161865234,490.09075927734,5.2716755867004},{-1403.6955566406,496.50296020508,3.0390625},{-1385.0307617188,495.380859375,3.0444478988647},{-1384.8807373047,498.41778564453,3.0390625},{-1380.0249023438,499.37905883789,3.0390625},{-1375.7811279297,493.40786743164,3.0390625},{-1369.7567138672,495.68057250977,10.216180801392},{-1367.0539550781,496.95138549805,11.1953125},{-1371.2563476563,499.65795898438,11.1953125},{-1370.1925048828,492.87322998047,11.1953125},{-1363.9310302734,493.55661010742,11.1953125},{-1359.7774658203,499.24960327148,11.1953125},{-1354.5910644531,498.54998779297,11.1953125},{-1348.4920654297,495.09567260742,11.1953125},{-1343.4635009766,497.18981933594,11.1953125},{-1338.19140625,496.66937255859,11.1953125},{-1336.7901611328,486.59368896484,11.180843353271},{-1333.7755126953,485.40124511719,11.1875},{-1336.0667724609,500.07534790039,11.3046875},{-1329.0397949219,492.89385986328,11.1953125},{-1322.9178466797,496.42224121094,11.1953125},{-1317.2899169922,503.43811035156,11.1953125},{-1318.2720947266,508.20889282227,11.1953125},{-1325.4117431641,512.0244140625,11.1953125},{-1322.3941650391,516.48468017578,11.197099685669},{-1328.9279785156,516.84588623047,11.197099685669},{-1366.5230712891,514.00103759766,11.1953125},{-1362.4392089844,508.72747802734,11.1953125},{-1361.3571777344,503.275390625,11.1953125},{-1365.7182617188,507.1340637207,11.1953125},{-1368.8382568359,503.90719604492,11.1953125},{-1384.1197509766,502.50704956055,11.322366714478},{-1398.2799072266,502.66296386719,11.3046875},{-1396.3507080078,498.69155883789,11.202615737915},{-1396.2265625,491.84869384766,11.1953125},{-1403.1788330078,491.53948974609,11.1953125},{-1404.0284423828,495.9567565918,11.1953125},{-1429.1546630859,509.21585083008,11.1953125},{-1431.810546875,501.26702880859,11.1953125},{-1457.9833984375,493.58459472656,10.0078125},{-1460.5650634766,507.02478027344,10.0078125},{-1442.8043212891,506.58920288086,18.234375},{-1442.5584716797,502.73544311523,18.234375},{-1442.2364501953,496.97549438477,18.234375},{-1366.2221679688,515.28698730469,11.208438873291},{-1325.0452880859,514.80627441406,11.180843353271},{-1329.755859375,512.64440917969,13.443550109863},{-1344.6927490234,507.73162841797,11.1953125},{-1346.5463867188,493.15264892578,11.202690124512},{-1347.73828125,491.35580444336,11.1953125},{-1347.9014892578,494.80731201172,11.1953125},},
		["difficulty"] = 3,
		["dim"] = 1002,
		["int"] = 0,
		["startVeh"]=473,
		["time"] = 45,
		["botCount"] = 35, ["waveBotCount"] = 6, ["botExp"] = 2.5,
		["blips"] = true,
		["reward"] = 300,
		["plaCount"] = 0, ["allPlayers"] = {}, ["status"] = "waiting", ["open"] = false,
	},
	lvarmy = {
		["timers"] = {},
		["name"] = "Uncle Sam needs you", ["levelReq"] = 8, ["entrancepos"] = {9999,9999,9999}, ["startpos"] = {221.91735839844,1859.7004394531,13.14695930481}, ["coppos"] = {268.79843139648,1876.6888427734,8.4375}, ["cashpos"] = {268.61026000977,1883.2786865234,-30.09375},
		["bots"] = {{239.88726806641,1860.8713378906,14.084012031555},{241.63873291016,1880.5441894531,11.4609375},{255.5269317627,1880.5483398438,11.4609375},{262.13653564453,1866.5690917969,8.7578125},{244.34103393555,1871.9390869141,8.7649898529053},{244.00636291504,1866.2991943359,8.7649898529053},{257.5227355957,1850.0095214844,8.7578125},{268.03173828125,1839.0710449219,6.4918823242188},{269.95425415039,1838.4818115234,6.5031280517578},{249.71151733398,1832.0557861328,7.5546875},{252.48431396484,1827.3166503906,7.5546875},{238.92185974121,1807.0861816406,6.171875},{255.5632019043,1807.1104736328,4.7109375},{251.4841003418,1807.2025146484,4.7109375},{245.07563781738,1814.4881591797,4.7109375},{256.70840454102,1800.5178222656,7.5375270843506},{256.76522827148,1803.3299560547,7.5403056144714},{237.3067779541,1801.7470703125,7.4140625},{236.68792724609,1832.0628662109,7.4140625},{227.40026855469,1817.9145507813,7.3395099639893},{227.09320068359,1827.9660644531,7.2944688796997},{214.04316711426,1828.6728515625,6.4140625},{214.17512512207,1816.9368896484,6.4140625},{225.89405822754,1822.4522705078,6.4140625},{258.35391235352,1816.8521728516,1.0078125},{295.47723388672,1818.5540771484,1.3344750404358},{297.88629150391,1820.5028076172,7.8205146789551},{276.45001220703,1820.8540039063,7.828125},{277.44073486328,1839.3745117188,7.828125},{297.40447998047,1840.4252929688,7.828125},{307.55975341797,1838.9587402344,7.7265625},{330.16522216797,1839.4790039063,7.828125},{323.83773803711,1855.5004882813,7.7265625},{297.52984619141,1847.1229248047,7.7265625},{276.03363037109,1873.0090332031,8.7648944854736},{269.71276855469,1854.9241943359,8.7578125},{276.68939208984,1891.6112060547,8.4375},{261.17987060547,1891.8013916016,8.4375},{274.57769775391,1878.0393066406,-1.3046875},{262.44570922852,1889.7916259766,-10.6953125},{274.47326660156,1877.9072265625,-20.078125},{262.83322143555,1890.1861572266,-29.421875},{274.98135375977,1878.4207763672,-30.390625},{263.52545166016,1878.3364257813,-30.390625},{274.98699951172,1889.6923828125,-29.387929916382},},
		["difficulty"] = 3,
		["dim"] = 1003,
		["int"] = 0,
		["time"] = 15,
		["botCount"] = 30, ["waveBotCount"] = 5, ["botExp"] = 2,
		["blips"] = true,
		["reward"] = 200,
		["plaCount"] = 0, ["allPlayers"] = {}, ["status"] = "waiting", ["open"] = false,
	}
}





addEventHandler( "onResourceStart", resourceRoot, 
function (  )
	for k,v in pairs( heistTable ) do
		v["parent"] = createElement( "parentelement" )
		--createMarker( v["startpos"][1], v["startpos"][2], v["startpos"][3], "checkpoint", 2, int r = 0, int g = 0, int b = 255, int a = 255, visibleTo = getRootElement( ) ] )
		v["obj"] = createObject( 1279, v["cashpos"][1], v["cashpos"][2], v["cashpos"][3] )
		v["stashCol"] = createColSphere( v["cashpos"][1], v["cashpos"][2], v["cashpos"][3], 4 )
		v["startCol"] = createColSphere( v["startpos"][1], v["startpos"][2], v["startpos"][3], 4 )
		addEventHandler( "onColShapeHit", v["startCol"], 	heistPlayerHitLeave )
		addEventHandler( "onColShapeHit", v["stashCol"], 	heistPlayerHitStash )
		setElementDimension( v["stashCol"], v["dim"] ) 	setElementInterior( v["stashCol"], v["int"] )
		setElementDimension( v["startCol"], v["dim"] )	setElementInterior( v["startCol"], v["int"] )
		setElementDimension( v["obj"], v["dim"] )			setElementInterior( v["obj"], v["int"] ) setElementCollisionsEnabled( v["obj"], false )

		v["blips"] = {
		["stash"] = createBlip( v["cashpos"][1], v["cashpos"][2], v["cashpos"][3] ),
		["start"] = createBlip( v["startpos"][1], v["startpos"][2], v["startpos"][3] )
		}
		setElementDimension( v["blips"]["start"], v["dim"] )	setElementInterior( v["blips"]["start"], v["int"] )
		setElementDimension( v["blips"]["stash"], v["dim"] )	setElementInterior( v["blips"]["stash"], v["int"] )
		setElementVisibleTo( v["blips"]["stash"], root, false ) setElementVisibleTo( v["blips"]["start"], root, false )

		local stashcorona = createMarker( v["cashpos"][1], v["cashpos"][2], v["cashpos"][3], "corona", 2, 0,200,0, 200 )
		local startcorona = createMarker( v["startpos"][1], v["startpos"][2], v["startpos"][3], "corona", 2, 200,200,0, 200 )
		setElementDimension( stashcorona, v["dim"] )	setElementInterior( stashcorona, v["int"] )
		setElementDimension( startcorona, v["dim"] )	setElementInterior( startcorona, v["int"] )


		v["entranceCol"] = createColSphere( v["entrancepos"][1], v["entrancepos"][2], v["entrancepos"][3], 4 )
		setElementParent( v["entranceCol"], eventparent )
		setElementData( v["entranceCol"], "eventType", "heist" )
		setElementData( v["entranceCol"], "heistName", k, false )
		addEventHandler( "onColShapeHit", v["entranceCol"],
		function ( el, md )
			local pla = el
			if isElement( pla ) and getElementType( pla ) == "player" and md then
				if getElementData( pla, "lvl" ) >= v["levelReq"] then
					if v["open"] then
						outputChatBox( "[Heist] Pamiętaj aby przed wejściem kupić bronie.", pla, 50,153,50 )
						triggerClientEvent( pla, "heistOnEnterShow", pla, source )
					else
						outputChatBox( "[Heist] Nie możesz dołączyć do tego heista w tym momencie.", pla, 225,25,25 )
					end
				else
					outputChatBox( "[Heist] Twój poziom nie jest wystarczająco wysoki..", pla, 225,25,25 )
				end
			end
		end )

		local points = getElementsByType( "loot" )
        local x,y,z = getElementPosition( points[math.random(1,#points)] )
		setElementPosition( v["entranceCol"], x,y,z )
		v["entrancepos"] = {x,y,z}
	end

	setTimer(
	function (  )
		heistOpenRandom()
		heistOpenRandom()
	end, 1000*10, 1 )
end )

function heistSpawn( pla, heistName )
	saveWeapons( pla )
	local heist = heistTable[heistName]
	local pos = nil
	if getElementDimension( pla ) ~= heist["dim"] and isPedDead( pla ) then return end

	if getElementData( pla, "gang" ) == "police" then
		if not getElementData( pla, "heistName" ) then
			setElementData( pla, "heistLives", 1 )
			heistTable[heistName]["plaCount"] = heistTable[heistName]["plaCount"]+1
		end
		pos = heist["coppos"]
		setElementData( pla, "heistStatus", "defending" )
		outputChatBox( "[Heist] Nie pozwól gangom dostać się do schowka..", pla, 50,153,50 )
	else
		if not getElementData( pla, "heistName" ) then
			setElementData( pla, "heistLives", 4 )
			heistTable[heistName]["plaCount"] = heistTable[heistName]["plaCount"]+1
		end
		pos = heist["startpos"]
		setElementData( pla, "heistStatus", "searching" )
	end
	heistTable[heistName]["allPlayers"][pla] = true
	setElementData( pla, "heistName", heistName )
	spawnPlayer( pla, pos[1], pos[2], pos[3], 0, getElementData( pla, "skin" ), heist["int"], heist["dim"] )
	loadWeapons( pla, true )
	--setElementVisibleTo( heist["obj"], pla, true )

	if heist["status"] == "waiting" then
		local heist = heistTable[heistName]
		heistSpawnBots( heistName, heist["botCount"] )
		heist["status"] = "started"
		heist["timers"][#heist["timers"]+1] = setTimer( 
		function (  )
			triggerClientEvent( root, "notif", resourceRoot, "Heist '"..heist["name"].."' został zamknięty!", "info")
			heist["open"] = false
		end, 1000*60*3, 1, heistName )
	end

	setPlayerBlipped( pla )
	maxPlayerStats( pla )

	if heist["startVeh"] then
		local veh = createVehicle( heist["startVeh"], pos[1], pos[2], pos[3] )
		setElementDimension( veh, heist["dim"] ) setElementInterior( veh, heist["int"] )
		warpPedIntoVehicle( pla, veh )
		setElementParent( veh, heist["parent"] )
		addEventHandler( "onPlayerSpawn", pla, function (  ) if isElement( veh ) then destroyElement( veh ) end end )
	end

	if heist["blips"] then
		setElementVisibleTo( heist["blips"]["stash"], root, true )
		setElementVisibleTo( heist["blips"]["start"], root, false )
	end
end

function heistCheckOpen( heistName )
	heist = heistTable[heistName]
	if heist["plaCount"] > 0 then
		heist["open"] = false
	else
		heist["open"] = true
	end
end

function heistPlayerLeave( pla, quit )
	local heistName = getElementData( pla, "heistName" )
	local heist = heistTable[heistName]
	if heist then
		heist["plaCount"] = heist["plaCount"]-1 
		if heist["plaCount"] <= 0 then
			--heist["open"] = true
			heist["status"] = "waiting"
			heist["plaCount"] = 0
			heist["allPlayers"] = {}
			for k,v in ipairs( getElementChildren( heist["parent"] ) ) do destroyElement( v ) end
			for i,v in ipairs( heist["timers"] ) do if isTimer( v ) then killTimer( v ) end end
			heist["timers"] = {}
		end

		if not quit then
			setElementData( pla, "heistStashTaken", false )
			setElementData( pla, "heistName", false )
			setElementData( pla, "heistLives", false )
			spawn( pla )
			if heist["blips"] then
				setElementVisibleTo( heist["blips"]["stash"], pla, false )
				setElementVisibleTo( heist["blips"]["start"], pla, false )
			end
		end
	end
end
addEventHandler( "onPlayerQuit", root, function (  ) heistPlayerLeave( source, true )  end )

function heistPlayerHitStash( pla, md, col )
	local colli = source
	if md and getElementType( pla ) == "player" then
		local status = getElementData( pla, "heistStatus" )
		local heistName = getElementData( pla, "heistName" )
		local timestamp = getElementData( pla, "heistTimestamp" )
		local heist = heistTable[heistName]
		if not col or isElementWithinColShape( pla, col ) then
	 		if status == "searching" then
				setElementData( pla, "heistStatus", "found" )
				setElementData( pla, "heistTimestamp", getRealTime()["timestamp"]+heist["time"] )
				setTimer( function (  ) outputChatBox( "[Heist] Weź towar.", pla, 50,153,50 ) heistPlayerHitStash( pla, true, colli ) end, 1000*heist["time"], 1 )
				if #heist["bots"]>0 then setTimer( function (  ) heistSpawnBots( heistName, 1 ) end, 1000 * heist["time"]/heist["waveBotCount"], heist["waveBotCount"] ) end
				outputChatBox( "Ochraniaj schowka. Odczekaj "..heist["time"].." sekund.", pla, 50,153,50 )
			elseif status == "found" then
				if getRealTime()["timestamp"]>=timestamp then
					outputChatBox( "[Heist] You got the stash, get to the exit.", pla, 50,153,50 )
					setElementData( pla, "heistStatus", "escaping" )
					heistAttachStash( pla, heist["dim"], heist["int"] )
					if heist["blips"] then
						setElementVisibleTo( heist["blips"]["stash"], pla, false )
						setElementVisibleTo( heist["blips"]["start"], pla, true )
					end
					--setElementVisibleTo( heistTable[getElementData( pla, "heistName" )]["obj"], pla, false )
				else
					outputChatBox( "[Heist] Musisz jeszcze czekać "..timestamp-getRealTime()["timestamp"].." sekund.", pla, 255,140,0 )
				end
			end
		end
	end
end

function heistPlayerHitLeave( pla, md )
	if md and isElement( pla ) and getElementType( pla ) == "player" then
		if getElementData( pla, "heistStatus" ) == "escaping" then
			local heist = heistTable[getElementData( pla, "heistName" )]
			heistPlayerLeave( pla )
			local stash = heistAttachStash( pla, 0,0 )
			local plablip = createBlipAttachedTo( pla, 56 )
			local points = getElementsByType( "loot" )
	        local x,y,z = getElementPosition( points[math.random(1,#points)] )
	        local blip = createBlip( x,y,z, 19, 2, nil, nil, nil, nil, nil, nil, pla )
			local col = createColSphere( x,y,z, 5 )
			local marker = createMarker( x,y,z, "checkpoint", 4.0, 200,0,200, 150, pla )
			local reward = addMoney( pla, heist["reward"], false, true )
            addBounty( pla, reward/2 )
			--setElementParent( plablip, stash ) setElementParent( blip, stash ) setElementParent( col, stash )
			addEventHandler( "onElementDestroy", stash, function() destroyElement( plablip ) destroyElement( blip ) destroyElement( col ) destroyElement( marker ) end )
			addEventHandler( "onColShapeHit", col,
			function ( el, md )
				if md and el == pla then
					triggerEvent( "heistDetachStash", pla )
					addMoney( pla, reward )
					outputChatBox( "[Heist] Napad ukończony. Zarobiłeś "..heist["reward"].."$!", pla, 50,200,50 )
            		addBounty( pla, -reward )
				end
			end )
		elseif getElementData( pla, "heistStatus" ) == "searching" then
			outputChatBox( "[Heist] Znajdź schowek i zabierz towar.", pla, 50,153,50 )
		end
	end
end

function heistSpawnBots( heistName, count )
	local heist = heistTable[heistName]
	local botsUnused = {}
	for i,v in ipairs( heist["bots"] ) do botsUnused[#botsUnused+1] = v end
	for i=1,count do
		local rand = math.random( 1, #botsUnused )
		local pos = botsUnused[rand]
		table.remove( botsUnused, rand )
		local ped = spawnBot( pos[1],pos[2],pos[3], 0, 285, heist["int"], heist["dim"], getTeamFromName( "Policja" ), 29, "hunting" )
		setElementData( ped, "gang", "police", false )
		setElementParent( ped, heist["parent"] )
		addEventHandler( "onPedWasted", ped,
		function ( totAmm, att, attWpn, bodypart )
			local bot = source
			if isElement( att ) and getElementType( att ) == "player" and isPedBot( bot ) then
				local gang = getElementData( att, "gang" )
				if getElementData( bot, "gang" ) == "police" and gang == "police" then
					addMoney( att, -5 )
					setElementHealth( att, getElementHealth( att )-25 )
					outputChatBox( "[Heist] Nie możesz zabijać innych policjantów! Straciłeś 5$ i 25HP.", att, 255,69,0 )
				else
					local xp = addExp( att, heist["botExp"] )
					outputChatBox( "[Heist] Zdobyłeś "..xp.."XP!", att, 25,225,25 )
				end
			end
		end )
		--setElementDimension( ped, heist["dim"] )	setElementInterior( pped, heist["int"] )
		--setBotTeam( ped, getTeamFromName( "Police" ) )
		--outputChatBox( getBotTeam( ped ) )
	end
end

addEventHandler( "onPlayerWasted", root, 
function ( totAmm, att, attWpn, bodypart )
	local pla = source
	local dim = getElementDimension( pla )
	if not lobbys[dim] then
		local heistName = getElementData( pla, "heistName" )
		if heistName then
			local lives = getElementData( pla, "heistLives" )
			if lives>1 then
				setElementData( pla, "heistLives", lives-1, false )
				outputChatBox( "[Heist] Zostało ci " .. lives-1 .. " żyć(ia) . Odrodzenie za 15 sekund.", pla, 255,140,0 )
				setTimer( heistSpawn, 15000, 1, pla, heistName )
			else
				outputChatBox( "[Heist] Nie zostalo już więcej żyć.", pla, 255,69,0 )
				setTimer( heistPlayerLeave, 5000, 1, pla )
			end
		end
	end
end )



addEvent( "heistRequest", true )
addEventHandler( "heistRequest", root,
function ( req, col )
	if col and isElement( col ) and isElementWithinColShape( client, col ) then
		if req == "enter" then
			local heistName = getElementData( col, "heistName", false )
			if heistName then
				if not heistTable[heistName]["allPlayers"][client] then
					if heistTable[heistName]["open"] then
						savePlayer( client )
						addWanted( client, 10 )
	                	outputChatBox( "[Heist] Aby wyjść z tego napadu napisz '/heistleave'.", client, 225,225,25 )
						heistSpawn( client, heistName )
						triggerEvent( "onSafezoneLeave", client )
					else
						outputChatBox( "[Heist] Ten napad jest zamknięty.", client, 255,69,0 )
					end
				else
					outputChatBox( "[Heist] Już byłeś w tym napadzie.", client, 255,69,0 )
				end
			end
		end
	end
end )

addCommandHandler( "heistleave",
function ( pla )
	if getElementData( pla, "heistName", false ) then
		heistPlayerLeave( pla )
	end
end )

addEvent( "heistDetachStash" )	
function heistAttachStash( pla, dim, int )
	local obj = createObject( 1279, 0,0,0 ) setElementDimension( obj, dim ) setElementInterior( obj, int )
    attachElementToBone( obj, pla, 3, 0,-0.3,0, 15,90,90 )
    setObjectScale( obj, 0.8 )
	addEventHandler( "onPlayerSpawn", pla, function (  ) if isElement( obj ) then detachElementFromBone( obj ) destroyElement( obj ) end end )
	addEventHandler( "onPlayerQuit", pla, function (  ) if isElement( obj ) then detachElementFromBone( obj ) destroyElement( obj ) end end )
	addEventHandler( "heistDetachStash", pla, function (  ) if isElement( obj ) then detachElementFromBone( obj ) destroyElement( obj ) end end )
	return obj
end

function heistOpenRandom(  )
	local indexed = {}
	local openCount = 0
	for k,v in pairs( heistTable ) do
		if v["open"] then
			openCount = openCount + 1
		else
			indexed[#indexed+1] = v
		end
	end
	if openCount < 2 then
		local heist = indexed[math.random(1,#indexed)]
		heist["open"] = true
		heist["status"] = "waiting"
		triggerClientEvent( root, "notif", resourceRoot, "Napad '"..heist["name"].."' (Level: "..heist["levelReq"]..") został otwarty!", "info")
	end
end
setTimer( heistOpenRandom, 1000*60*40, 0 )
